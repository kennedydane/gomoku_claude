{% extends 'base.html' %}

{% block title %}Dashboard - Gomoku{% endblock %}

{% block content %}
<!-- WebSocket Connection Container (Single connection for entire dashboard) -->
<div id="websocket-container" 
     hx-ext="ws" 
     ws-connect="/ws/user/{{ user.id }}/"
     style="display: none;"></div>

<!-- Welcome Header -->
<div class="row mb-4">
    <div class="col-12">
        <h1>Welcome back, {{ user.username }}!</h1>
    </div>
</div>
    
    <div class="row">
        <!-- Left Panel - Games -->
        <div class="col-lg-2 col-md-3 d-none d-md-block">
            <div class="sticky-top" style="top: 20px;" 
                 id="dashboard-games-panel">
                {% include 'web/partials/games_panel.html' %}
            </div>
        </div>
        
        <!-- Main Content - Embedded Game Panel -->
        <div class="col-lg-8 col-md-9 col-12"
             id="dashboard-center-panel">
            <!-- Embedded Game Display -->
            {% include 'web/partials/dashboard_game_panel.html' %}
            
            <!-- Pending challenges are now displayed in the friends panel -->
            
            <!-- Quick Stats (compact) -->
            <div class="card mt-4">
                <div class="card-body p-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="stat-compact">
                                <div class="stat-value h5 mb-1 text-primary">{{ games_played }}</div>
                                <div class="stat-label small text-muted">Games Played</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-compact">
                                <div class="stat-value h5 mb-1 text-success">{{ games_won }}</div>
                                <div class="stat-label small text-muted">
                                    Games Won
                                    {% if games_played > 0 %}
                                        <br><span class="text-primary">({% widthratio games_won games_played 100 %}%)</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel - Friends -->
        <div class="col-lg-2 d-none d-lg-block">
            <div class="sticky-top" style="top: 20px;" 
                 id="dashboard-friends-panel">
                {% include 'web/partials/friends_panel.html' %}
            </div>
        </div>
    </div>
    
    <!-- Mobile Panels (Collapsible) -->
    <div class="d-md-none mt-4">
        <div class="row">
            <div class="col-6">
                <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-games-panel">
                    <i class="bi bi-grid-3x3-gap"></i> Games
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-friends-panel">
                    <i class="bi bi-people"></i> Friends
                </button>
            </div>
        </div>
        
        <div class="collapse mt-3" id="mobile-games-panel">
            {% include 'web/partials/games_panel.html' %}
        </div>
        
        <div class="collapse mt-3" id="mobile-friends-panel">
            {% include 'web/partials/friends_panel.html' %}
        </div>
    </div>

<!-- HTMX Challenge Modal -->
<div class="modal fade" id="challenge-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div id="challenge-modal-container">
                <!-- Content loaded via HTMX -->
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Loading challenge form...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Friends Management Modal -->
<div class="modal fade" id="friends-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id="friends-modal-container">
                <!-- Content loaded via HTMX -->
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Loading friends management...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Games Management Modal -->
<div class="modal fade" id="games-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id="games-modal-container">
                <!-- Content loaded via HTMX -->
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Loading games...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Turn Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1060;">
    <div id="turn-notification-toast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-play-circle-fill me-2"></i>
                <span id="toast-message">It's your turn in a game!</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Additional CSS for dashboard -->
<style>
.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
    }
}

.challenge-item {
    transition: all 0.3s ease;
    border-left: 4px solid #ffc107 !important;
}

.challenge-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Your Turn Game Styling */
.game-item.your-turn {
    border-left: 4px solid #28a745 !important;
    background: linear-gradient(90deg, rgba(40, 167, 69, 0.05) 0%, transparent 100%) !important;
}

.game-item.your-turn:hover {
    background: linear-gradient(90deg, rgba(40, 167, 69, 0.1) 0%, transparent 100%) !important;
    transform: translateX(3px);
    box-shadow: 0 2px 6px rgba(40, 167, 69, 0.2);
}

/* Gentle pulse animation for turn indicators */
.pulse-gentle {
    animation: pulse-gentle 3s ease-in-out infinite;
}

@keyframes pulse-gentle {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.05);
        opacity: 0.9;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Turn indicator styling */
.my-turn {
    font-size: 0.75rem;
    font-weight: 600;
}

.their-turn {
    font-size: 0.7rem;
}

.challenger-avatar {
    position: relative;
}

.sticky-top {
    z-index: 1000;
}

/* Responsive tweaks */
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }
}

/* Modal z-index fix */
.modal {
    z-index: 1060 !important;
}

.modal-backdrop {
    z-index: 1055 !important;
}
</style>

<script>
// WebSocket Message Routing for Dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Configure HTMX to automatically include CSRF tokens from the page
    document.addEventListener('htmx:configRequest', function(event) {
        // Get CSRF token from the page's meta tag or cookie
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
                         getCookie('csrftoken');
        
        if (csrfToken) {
            // Add CSRF token to the request parameters
            event.detail.parameters['csrfmiddlewaretoken'] = csrfToken;
        }
    });
    
    // Helper function to get cookie value
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Listen for WebSocket messages and route them to appropriate panels
    document.addEventListener('htmx:wsAfterMessage', function(event) {
        const message = event.detail.message;
        let data;
        
        try {
            data = JSON.parse(message);
        } catch (e) {
            console.error('Failed to parse WebSocket message:', e);
            return;
        }
        
        console.log('WebSocket message received:', data.type);
        
        // Route messages based on type
        switch(data.type) {
            case 'dashboard_update':
                // Update games panel
                const gamesPanel = document.getElementById('dashboard-games-panel');
                if (gamesPanel && data.content) {
                    // Check if any new "your turn" games appeared
                    const oldYourTurnGames = gamesPanel.querySelectorAll('.your-turn').length;
                    
                    gamesPanel.innerHTML = data.content;
                    htmx.process(gamesPanel);
                    
                    // Check for new "your turn" games after update
                    const newYourTurnGames = gamesPanel.querySelectorAll('.your-turn').length;
                    
                    // Show toast notification if new turn games appeared
                    if (newYourTurnGames > oldYourTurnGames) {
                        showTurnNotification('It\'s your turn in a game!');
                    }
                }
                break;
                
            case 'dashboard_game_update':
                // Update center game panel
                const centerPanel = document.getElementById('dashboard-center-panel');
                if (centerPanel && data.content) {
                    centerPanel.innerHTML = data.content;
                    htmx.process(centerPanel);
                }
                break;
                
            case 'friends_update':
                // Update friends panel
                const friendsPanel = document.getElementById('dashboard-friends-panel');
                if (friendsPanel && data.content) {
                    friendsPanel.innerHTML = data.content;
                    htmx.process(friendsPanel);
                }
                break;
                
            case 'game_move':
                // Update embedded game board
                const gameBoard = document.getElementById('dashboard-game-board-content');
                if (gameBoard && data.content) {
                    gameBoard.innerHTML = data.content;
                    htmx.process(gameBoard);
                }
                break;
                
            case 'game_turn_update':
                // Update only the turn display in the current game panel
                const turnDisplay = document.getElementById('game-turn-display');
                if (turnDisplay && data.content) {
                    turnDisplay.innerHTML = data.content;
                    htmx.process(turnDisplay);
                    console.log('🔄 Turn display updated:', data.metadata || {});
                }
                break;
                
            case 'connection_status':
                console.log('WebSocket connection status:', data.status);
                break;
                
            default:
                console.log('Unknown WebSocket message type:', data.type);
        }
    });
    
    // Handle WebSocket connection events
    document.addEventListener('htmx:wsOpen', function(event) {
        console.log('WebSocket connected to dashboard');
        document.body.classList.add('ws-connected');
        document.body.classList.remove('ws-disconnected');
    });
    
    document.addEventListener('htmx:wsClose', function(event) {
        console.log('WebSocket disconnected from dashboard');
        document.body.classList.add('ws-disconnected');
        document.body.classList.remove('ws-connected');
    });
    
    document.addEventListener('htmx:wsError', function(event) {
        console.error('WebSocket error:', event.detail);
    });
    
    // Function to show turn notification toast
    function showTurnNotification(message) {
        const toast = document.getElementById('turn-notification-toast');
        const toastMessage = document.getElementById('toast-message');
        
        if (toast && toastMessage) {
            toastMessage.textContent = message;
            
            // Use Bootstrap's toast API
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 4000
            });
            bsToast.show();
        }
    }
    
    // Make function available globally for debugging
    window.showTurnNotification = showTurnNotification;
});
</script>

{% csrf_token %}
{% endblock %}