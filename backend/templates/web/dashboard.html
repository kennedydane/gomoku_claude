{% extends 'base.html' %}

{% block title %}Dashboard - Gomoku{% endblock %}

{% block content %}
<!-- WebSocket Connection Container (Single connection for entire dashboard) -->
<div id="websocket-container" 
     hx-ext="ws" 
     ws-connect="/ws/user/{{ user.id }}/"
     style="display: none;"></div>

<div class="container-fluid">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Welcome back, {{ user.username }}!</h1>
                <div class="d-flex gap-2">
                    <a href="{% url 'web:friends' %}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-person-plus"></i> Find Friends
                    </a>
                    <a href="{% url 'web:games' %}" class="btn btn-primary btn-sm">
                        <i class="bi bi-grid-3x3-gap"></i> All Games
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Left Panel - Games -->
        <div class="col-lg-2 col-md-3 d-none d-md-block">
            <div class="sticky-top" style="top: 20px;" 
                 id="dashboard-games-panel">
                {% include 'web/partials/games_panel.html' %}
            </div>
        </div>
        
        <!-- Main Content - Embedded Game Panel -->
        <div class="col-lg-8 col-md-9 col-12"
             id="dashboard-center-panel">
            <!-- Embedded Game Display -->
            {% include 'web/partials/dashboard_game_panel.html' %}
            
            <!-- Pending challenges are now displayed in the friends panel -->
            
            <!-- Quick Stats (compact) -->
            <div class="card mt-4">
                <div class="card-body p-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="stat-compact">
                                <div class="stat-value h5 mb-1 text-primary">{{ games_played }}</div>
                                <div class="stat-label small text-muted">Games Played</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-compact">
                                <div class="stat-value h5 mb-1 text-success">{{ games_won }}</div>
                                <div class="stat-label small text-muted">
                                    Games Won
                                    {% if games_played > 0 %}
                                        <br><span class="text-primary">({% widthratio games_won games_played 100 %}%)</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel - Friends -->
        <div class="col-lg-2 d-none d-lg-block">
            <div class="sticky-top" style="top: 20px;" 
                 id="dashboard-friends-panel">
                {% include 'web/partials/friends_panel.html' %}
            </div>
        </div>
    </div>
    
    <!-- Mobile Panels (Collapsible) -->
    <div class="d-md-none mt-4">
        <div class="row">
            <div class="col-6">
                <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-games-panel">
                    <i class="bi bi-grid-3x3-gap"></i> Games
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-friends-panel">
                    <i class="bi bi-people"></i> Friends
                </button>
            </div>
        </div>
        
        <div class="collapse mt-3" id="mobile-games-panel">
            {% include 'web/partials/games_panel.html' %}
        </div>
        
        <div class="collapse mt-3" id="mobile-friends-panel">
            {% include 'web/partials/friends_panel.html' %}
        </div>
    </div>
</div>

<!-- HTMX Challenge Modal -->
<div class="modal fade" id="challenge-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div id="challenge-modal-container">
                <!-- Content loaded via HTMX -->
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Loading challenge form...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional CSS for dashboard -->
<style>
.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
    }
}

.challenge-item {
    transition: all 0.3s ease;
    border-left: 4px solid #ffc107 !important;
}

.challenge-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.challenger-avatar {
    position: relative;
}

.sticky-top {
    z-index: 1000;
}

/* Responsive tweaks */
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }
}

/* Modal z-index fix */
.modal {
    z-index: 1060 !important;
}

.modal-backdrop {
    z-index: 1055 !important;
}
</style>

<script>
// WebSocket Message Routing for Dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Listen for WebSocket messages and route them to appropriate panels
    document.addEventListener('htmx:wsAfterMessage', function(event) {
        const message = event.detail.message;
        let data;
        
        try {
            data = JSON.parse(message);
        } catch (e) {
            console.error('Failed to parse WebSocket message:', e);
            return;
        }
        
        console.log('WebSocket message received:', data.type);
        
        // Route messages based on type
        switch(data.type) {
            case 'dashboard_update':
                // Update games panel
                const gamesPanel = document.getElementById('dashboard-games-panel');
                if (gamesPanel && data.content) {
                    gamesPanel.innerHTML = data.content;
                    htmx.process(gamesPanel);
                }
                break;
                
            case 'dashboard_game_update':
                // Update center game panel
                const centerPanel = document.getElementById('dashboard-center-panel');
                if (centerPanel && data.content) {
                    centerPanel.innerHTML = data.content;
                    htmx.process(centerPanel);
                }
                break;
                
            case 'friends_update':
                // Update friends panel
                const friendsPanel = document.getElementById('dashboard-friends-panel');
                if (friendsPanel && data.content) {
                    friendsPanel.innerHTML = data.content;
                    htmx.process(friendsPanel);
                }
                break;
                
            case 'game_move':
                // Update embedded game board
                const gameBoard = document.getElementById('dashboard-game-board-content');
                if (gameBoard && data.content) {
                    gameBoard.innerHTML = data.content;
                    htmx.process(gameBoard);
                }
                break;
                
            case 'connection_status':
                console.log('WebSocket connection status:', data.status);
                break;
                
            default:
                console.log('Unknown WebSocket message type:', data.type);
        }
    });
    
    // Handle WebSocket connection events
    document.addEventListener('htmx:wsOpen', function(event) {
        console.log('WebSocket connected to dashboard');
        document.body.classList.add('ws-connected');
        document.body.classList.remove('ws-disconnected');
    });
    
    document.addEventListener('htmx:wsClose', function(event) {
        console.log('WebSocket disconnected from dashboard');
        document.body.classList.add('ws-disconnected');
        document.body.classList.remove('ws-connected');
    });
    
    document.addEventListener('htmx:wsError', function(event) {
        console.error('WebSocket error:', event.detail);
    });
});
</script>

{% csrf_token %}
{% endblock %}